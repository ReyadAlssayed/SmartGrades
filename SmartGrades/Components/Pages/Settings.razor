@page "/Settings"
@layout MainLayout
@using SmartGrades.Model
@inject SmartGrades.Services.DataServices DataServices
@inject NavigationManager Nav

<div class="settings-page">

    <!-- ================= HEADER ================= -->
    <div class="settings-header">
        <div class="header-content">

            <div class="image-avatar">
                <img src="images/admin.png" />
            </div>

            <div class="user-info">
                <div class="user-name">
                    @Admin?.FullName
                </div>
            </div>

        </div>
    </div>

    <div class="settings-section-title">
        الإعدادات
    </div>

    <div class="settings-list">

        <div class="settings-item" @onclick="() => ShowProfileDialog = true">
            <div class="item-left">
                <img src="images/profile.png" class="item-icon" />
                <span>الملف الشخصي</span>
            </div>
            <span class="arrow">›</span>
        </div>

        <div class="settings-item" @onclick="() => ShowPasswordDialog = true">
            <div class="item-left">
                <img src="images/password.png" class="item-icon" />
                <span>تغيير كلمة المرور</span>
            </div>
            <span class="arrow">›</span>
        </div>

        <div class="settings-item" @onclick="GoToAdmins">
            <div class="item-left">
                <img src="images/Admins.png" class="item-icon" />
                <span>عرض قائمة المسؤولين في النظام</span>
            </div>
            <span class="arrow">›</span>
        </div>


        <div class="settings-item" @onclick="() => ShowReportDialog = true">
            <div class="item-left">
                <img src="images/tracking.png" class="item-icon" />
                <span>الدعم الفني</span>
            </div>
            <span class="arrow">›</span>
        </div>

        <div class="settings-item" @onclick="() => ShowAboutDialog = true">
            <div class="item-left">
                <img src="images/information.png" class="item-icon" />
                <span>حول النظام</span>
            </div>
            <span class="arrow">›</span>
        </div>

        <div class="settings-item version-item">
            <div class="item-left">
                <img src="images/tracking.png" class="item-icon" />
                <span>إصدار التطبيق</span>
            </div>
            <span class="version-text">
                SmartGrades · .NET 10 · 2026
            </span>
        </div>

        <button class="logout-btn" @onclick="Logout">
            <img src="images/logout.png" class="logout-icon" />
            تسجيل الخروج
        </button>

    </div>
</div>

@if (ShowProfileDialog)
{
    <div class="dialog-overlay">
        <div class="dialog-box">
            <h3>الملف الشخصي</h3>
            <p><strong>الاسم:</strong> @Admin?.FullName</p>
            <button class="dialog-close" @onclick="() => ShowProfileDialog = false">إغلاق</button>
        </div>
    </div>
}

@if (ShowPasswordDialog)
{
    <div class="dialog-overlay">
        <div class="dialog-box">

            <h3>تغيير كلمة المرور</h3>

            <input type="password" placeholder="كلمة المرور الحالية" @bind="CurrentPassword" />
            <input type="password" placeholder="كلمة المرور الجديدة" @bind="NewPassword" />
            <input type="password" placeholder="تأكيد كلمة المرور الجديدة" @bind="ConfirmPassword" />

            <button class="dialog-action" @onclick="ChangePassword">حفظ</button>
            <button class="dialog-close" @onclick="ClosePasswordDialog">إلغاء</button>

        </div>
    </div>
}

@if (ShowReportDialog)
{
    <div class="dialog-overlay">
        <div class="dialog-box">

            <h3>إبلاغ عن مشكلة أو ملاحظة</h3>

            <textarea class="dialog-textarea"
                      rows="4"
                      placeholder="يرجى وصف المشكلة أو الملاحظة هنا..."
                      @bind="ReportNotes"></textarea>

            <button class="dialog-action" @onclick="SendReport">إرسال البلاغ</button>
            <button class="dialog-close" @onclick="() => ShowReportDialog = false">إلغاء</button>

        </div>
    </div>
}

@if (ShowAboutDialog)
{
    <div class="dialog-overlay">
        <div class="dialog-box dialog-about">

            <div class="about-main-icon">
                <img src="images/information.png" />
            </div>

            <h3 class="about-title-black">حول النظام</h3>

            <div class="about-grid">

                <div class="about-box">
                    <span class="label">اسم النظام</span>
                    <strong>@SystemConfig?.SystemName</strong>
                </div>

                <div class="about-box">
                    <span class="label">اسم المطور</span>
                    <strong>رياض السيد</strong>
                </div>

                <div class="about-box">
                    <span class="label">رقم التواصل (واتساب)</span>
                    <strong>0910772372</strong>
                </div>

            </div>

            <div class="about-footer">
                © 2026 جميع الحقوق محفوظة
            </div>

            <button class="dialog-close"
                    @onclick="() => ShowAboutDialog = false">
                إغلاق
            </button>

        </div>
    </div>
}

@if (!string.IsNullOrEmpty(Message))
{
    <div class="dialog-overlay">
        <div class="dialog-box">
            <p style="text-align:center">@Message</p>
            <button class="dialog-close" @onclick="() => Message = string.Empty">حسناً</button>
        </div>
    </div>
}

@code {
    Admin? Admin;
    SystemSettings? SystemConfig;

    bool ShowProfileDialog;
    bool ShowPasswordDialog;
    bool ShowReportDialog;
    bool ShowAboutDialog;

    string CurrentPassword = "";
    string NewPassword = "";
    string ConfirmPassword = "";
    string ReportNotes = "";
    string Message = "";

    protected override async Task OnInitializedAsync()
    {
      
        SystemConfig = await DataServices.GetSystemSettingsAsync();
    }

    async Task ChangePassword()
    {
        if (NewPassword != ConfirmPassword)
        {
            Message = "كلمتا المرور غير متطابقتين";
            return;
        }

        var ok = await DataServices.ChangeAdminPasswordAsync(
            Admin!.Id,
            CurrentPassword,
            NewPassword
        );

        Message = ok ? "تم تغيير كلمة المرور" : "كلمة المرور الحالية غير صحيحة";
        ClosePasswordDialog();
    }

    void ClosePasswordDialog()
    {
        ShowPasswordDialog = false;
        CurrentPassword = "";
        NewPassword = "";
        ConfirmPassword = "";
    }

    async Task SendReport()
    {
        await DataServices.SendReportToAdminAsync(ReportNotes);
        Message = "تم إرسال البلاغ";
        ReportNotes = "";
        ShowReportDialog = false;
    }
    void GoToAdmins()
    {
        Nav.NavigateTo("/Admins");
    }

    void Logout()
    {
        Nav.NavigateTo("/", true);
    }
}

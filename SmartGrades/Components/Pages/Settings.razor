@page "/Settings"
@layout MainLayout

@inject SmartGrades.Services.DataServices DataServices
@inject NavigationManager Nav

<div class="settings-page">

    <!-- ================= HEADER ================= -->
    <div class="settings-header">
        <div class="header-content">

            <div class="image-avatar">
                <img src="images/teacher.png" />
            </div>

            <div class="user-info">
                <div class="user-name">
                    @TeacherName <span class="user-role"> — أستاذ</span>
                </div>
            </div>

        </div>
    </div>

    <div class="settings-section-title">
        الحساب والإعدادات
    </div>

    <!-- ================= SETTINGS LIST ================= -->
    <div class="settings-list">

        <div class="settings-item" @onclick="() => ShowProfileDialog = true">
            <div class="item-left">
                <img src="images/profile.png" class="item-icon" />
                <span>الملف الشخصي</span>
            </div>
            <span class="arrow">›</span>
        </div>

        <div class="settings-item" @onclick="() => ShowPasswordDialog = true">
            <div class="item-left">
                <img src="images/password.png" class="item-icon" />
                <span>تغيير كلمة المرور</span>
            </div>
            <span class="arrow">›</span>
        </div>

        <!-- 🔹 إرسال إعلان -->
        <div class="settings-item" @onclick="OpenAnnouncement">
            <div class="item-left">
                <img src="images/announcement.png" class="item-icon" />
                <span>إرسال إعلان (تجربة)</span>
            </div>
            <span class="arrow">›</span>
        </div>

        <div class="settings-item" @onclick="OpenAbout">
            <div class="item-left">
                <img src="images/information.png" class="item-icon" />
                <span>حول التطبيق</span>
            </div>
            <span class="arrow">›</span>
        </div>

        <div class="settings-item version-item">
            <div class="item-left">
                <img src="images/tracking.png" class="item-icon" />
                <span>إصدار التطبيق</span>
            </div>
            <span class="version-text">
                SmartGrades · .NET · 1447 هـ
            </span>
        </div>

        <button class="logout-btn" @onclick="Logout">
            <img src="images/logout.png" class="logout-icon" />
            تسجيل الخروج
        </button>

    </div>
</div>

<!-- ================= PROFILE ================= -->
@if (ShowProfileDialog)
{
    <div class="dialog-overlay">
        <div class="dialog-box">
            <h3>الملف الشخصي</h3>
            <p><strong>الاسم:</strong> @TeacherName</p>
            <p><strong>الدور:</strong> أستاذ</p>
            <button class="dialog-close" @onclick="() => ShowProfileDialog = false">إغلاق</button>
        </div>
    </div>
}

<!-- ================= CHANGE PASSWORD ================= -->
@if (ShowPasswordDialog)
{
    <div class="dialog-overlay">
        <div class="dialog-box">

            <h3>تغيير كلمة المرور</h3>

            <input type="password" placeholder="كلمة المرور الحالية" @bind="CurrentPassword" />
            <input type="password" placeholder="كلمة المرور الجديدة" @bind="NewPassword" />
            <input type="password" placeholder="تأكيد كلمة المرور" @bind="ConfirmPassword" />

            <button class="dialog-action" @onclick="ChangePassword">حفظ</button>
            <button class="dialog-close" @onclick="ClosePasswordDialog">إغلاق</button>

        </div>
    </div>
}

<!-- ================= ANNOUNCEMENT ================= -->
@if (ShowAnnouncementDialog)
{
    <div class="dialog-overlay">
        <div class="dialog-box">

            <h3>📢 إرسال إعلان (اختبار)</h3>

            <p style="text-align:center;font-size:13px;color:#6b7280">
                سيتم الإرسال إلى رقم واحد فقط للتجربة
            </p>

            <p style="text-align:center">
                سيتم إرسال تقرير نهاية الشهر تلقائيًا
            </p>


            <button class="dialog-action" @onclick="ConfirmAnnouncement">
                إرسال
            </button>

            <button class="dialog-close" @onclick="CloseAnnouncement">
                إلغاء
            </button>

        </div>
    </div>
}

@if (ShowConfirmDialog)
{
    <div class="dialog-overlay">
        <div class="dialog-box">

            <h3>تأكيد الإرسال</h3>
            <p style="text-align:center">هل أنت متأكد؟</p>

            <button class="dialog-action" @onclick="SendAnnouncement">
                نعم، إرسال
            </button>

            <button class="dialog-close" @onclick="() => ShowConfirmDialog = false">
                رجوع
            </button>

        </div>
    </div>
}

<!-- ================= RESULT ================= -->
@if (ShowResultDialog)
{
    <div class="dialog-overlay">
        <div class="dialog-box">
            <p style="text-align:center">@DialogMessage</p>
            <button class="dialog-close" @onclick="CloseResultDialog">حسناً</button>
        </div>
    </div>
}

@code {

    bool ShowProfileDialog;
    bool ShowPasswordDialog;
    bool ShowAboutDialog;

    bool ShowAnnouncementDialog;
    bool ShowConfirmDialog;
    bool ShowResultDialog;

    string AnnouncementText = "";

    string DialogMessage = "";

    string CurrentPassword = "";
    string NewPassword = "";
    string ConfirmPassword = "";

    string TeacherName => DataServices.CurrentTeacher?.FullName ?? "—";

    void OpenAnnouncement()
    {
        ShowAnnouncementDialog = true;
        AnnouncementText = "";
    }

    void CloseAnnouncement()
    {
        ShowAnnouncementDialog = false;
        AnnouncementText = "";
    }

    void ConfirmAnnouncement()
    {
     

        ShowConfirmDialog = true;
    }
    async Task SendAnnouncement()
    {
        await DataServices.SendReportToAdminAsync(
            "📊 تقرير نهاية الشهر\nالإيرادات: 12000\nالمصروفات: 4300"
        );

        ShowConfirmDialog = false;
        ShowAnnouncementDialog = false;
        ShowMessage("تم إرسال التقرير");
    }


    

    void ShowMessage(string msg)
    {
        DialogMessage = msg;
        ShowResultDialog = true;
    }

    void CloseResultDialog()
    {
        ShowResultDialog = false;
        DialogMessage = "";
    }

    async Task ChangePassword()
    {
        var ok = await DataServices.ChangePasswordAsync(CurrentPassword, NewPassword);
        ShowMessage(ok ? "تم التغيير" : "فشل التغيير");
        ClosePasswordDialog();
    }

    void ClosePasswordDialog()
    {
        ShowPasswordDialog = false;
        CurrentPassword = "";
        NewPassword = "";
        ConfirmPassword = "";
    }

    void OpenAbout() => ShowAboutDialog = true;

    void Logout()
    {
        DataServices.Logout();
        Nav.NavigateTo("/", true);
    }

}

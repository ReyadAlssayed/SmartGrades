@page "/Settings"
@layout MainLayout

@inject SmartGrades.Services.DataServices DataServices
@inject NavigationManager Nav

<div class="settings-page">

    <!-- ================= HEADER ================= -->
    <div class="settings-header">
        <div class="header-content">

            <div class="image-avatar">
                <img src="images/teacher.png" />
            </div>

            <div class="user-info">
                <div class="user-name">
                    @TeacherName <span class="user-role"> — أستاذ</span>
                </div>
            </div>

        </div>
    </div>

    <!-- ================= SETTINGS LIST ================= -->
    <div class="settings-list">

        <div class="settings-item" @onclick="() => ShowProfileDialog = true">
            <span>الملف الشخصي</span>
            <span class="arrow">›</span>
        </div>

        <div class="settings-item" @onclick="() => ShowPasswordDialog = true">
            <span>تغيير كلمة المرور</span>
            <span class="arrow">›</span>
        </div>

        <div class="settings-item" @onclick="OpenAbout">
            <span>حول التطبيق</span>
            <span class="arrow">›</span>
        </div>

        <div class="settings-item version-item">
            <span>إصدار التطبيق</span>
            <span class="version-text">
                SmartGrades · .NET 10 MAUI · السنة 1447 هـ
            </span>
        </div>

        <button class="logout-btn" @onclick="Logout">
            <img src="images/logout.png" class="logout-icon" />
            تسجيل الخروج
        </button>

    </div>
</div>

<!-- ================= PROFILE DIALOG ================= -->
@if (ShowProfileDialog)
{
    <div class="dialog-overlay">
        <div class="dialog-box">

            <h3>الملف الشخصي</h3>

            <p><strong>الاسم:</strong> @TeacherName</p>
            <p><strong>الدور:</strong> أستاذ</p>

            <button class="dialog-close" @onclick="() => ShowProfileDialog = false">
                إغلاق
            </button>

        </div>
    </div>
}

<!-- ================= CHANGE PASSWORD DIALOG ================= -->
@if (ShowPasswordDialog)
{
    <div class="dialog-overlay">
        <div class="dialog-box">

            <h3>تغيير كلمة المرور</h3>

            <input type="password"
                   placeholder="كلمة المرور الحالية"
                   @bind="CurrentPassword" />

            <input type="password"
                   placeholder="كلمة المرور الجديدة"
                   @bind="NewPassword" />

            <input type="password"
                   placeholder="تأكيد كلمة المرور الجديدة"
                   @bind="ConfirmPassword" />

            <button class="dialog-action" @onclick="ChangePassword">
                حفظ التغيير
            </button>

            <button class="dialog-close" @onclick="ClosePasswordDialog">
                إغلاق
            </button>

        </div>
    </div>
}

<!-- ================= ABOUT DIALOG ================= -->
@if (ShowAboutDialog)
{
    <div class="dialog-overlay">
        <div class="dialog-box dialog-large">

            <h3>حول SmartGrades</h3>

            <video class="about-video"
                   preload="metadata"
                   autoplay
                   muted
                   playsinline
                   controls
                   @onended="OnVideoEnded">
                <source src="images/video1.mp4" type="video/mp4" />
                المتصفح لا يدعم تشغيل الفيديو
            </video>

            @if (ShowAboutText)
            {
                <div class="about-text">
                    SmartGrades نظام ذكي لإدارة الدرجات ومتابعة الطلاب،
                    صُمم ليكون بسيطًا، سريعًا، وآمنًا للأساتذة.
                </div>
            }

            <button class="dialog-close" @onclick="CloseAbout">
                إغلاق
            </button>

        </div>
    </div>
}

<!-- ================= RESULT DIALOG (SUCCESS / ERROR) ================= -->
@if (ShowResultDialog)
{
    <div class="dialog-overlay">
        <div class="dialog-box @DialogType">

            <div class="dialog-icon">
                @(DialogType == "success" ? "✔" : "✖")
            </div>

            <p>@DialogMessage</p>

            <button class="dialog-close" @onclick="CloseResultDialog">
                حسناً
            </button>

        </div>
    </div>
}

@code {

    // ================= STATE =================
    bool ShowProfileDialog = false;
    bool ShowPasswordDialog = false;
    bool ShowAboutDialog = false;
    bool ShowAboutText = false;

    bool ShowResultDialog = false;
    string DialogMessage = "";
    string DialogType = ""; // success | error

    string CurrentPassword = "";
    string NewPassword = "";
    string ConfirmPassword = "";

    string TeacherName => DataServices.CurrentTeacher?.FullName ?? "—";

    // ================= ABOUT =================
    void OpenAbout()
    {
        ShowAboutDialog = true;
        ShowAboutText = false;
    }

    void OnVideoEnded()
    {
        ShowAboutText = true;
    }

    void CloseAbout()
    {
        ShowAboutDialog = false;
        ShowAboutText = false;
    }

    // ================= PASSWORD =================
    async Task ChangePassword()
    {
        if (string.IsNullOrWhiteSpace(CurrentPassword))
        {
            ShowError("أدخل كلمة المرور الحالية");
            return;
        }

        if (NewPassword.Length < 6 || NewPassword.Length > 30)
        {
            ShowError("كلمة المرور الجديدة يجب أن تكون بين 6 و 30 حرفًا");
            return;
        }

        if (NewPassword != ConfirmPassword)
        {
            ShowError("كلمتا المرور غير متطابقتين");
            return;
        }

        var success = await DataServices.ChangePasswordAsync(
            CurrentPassword,
            NewPassword
        );

        if (!success)
        {
            ShowError("كلمة المرور الحالية غير صحيحة");
            return;
        }

        ShowSuccess("تم تغيير كلمة المرور بنجاح");

        ClosePasswordDialog();
    }

    void ClosePasswordDialog()
    {
        ShowPasswordDialog = false;
        CurrentPassword = "";
        NewPassword = "";
        ConfirmPassword = "";
    }

    // ================= RESULT =================
    void ShowError(string text)
    {
        DialogMessage = text;
        DialogType = "error";
        ShowResultDialog = true;
    }

    void ShowSuccess(string text)
    {
        DialogMessage = text;
        DialogType = "success";
        ShowResultDialog = true;
    }

    void CloseResultDialog()
    {
        ShowResultDialog = false;
        DialogMessage = "";
        DialogType = "";
    }

    // ================= LOGOUT =================
    void Logout()
    {
        DataServices.Logout();
        Nav.NavigateTo("/", true);
    }
}
